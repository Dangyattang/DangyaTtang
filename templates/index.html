<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¹ì‹ ì€ ì•¼ì‹ì´ ë•¡ê¸´ë‹¤</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.3/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="max-w-6xl mx-auto p-8 mt-16 bg-white shadow-lg rounded-lg">
        <h2 class="text-3xl font-bold text-center mb-6">ë‹¹ì‹ ì€ ì•¼ì‹ì´ ë•¡ê¸´ë‹¤</h2>

        {% if username %}
            <div class="text-center mb-4">
                <p>ì•ˆë…•í•˜ì„¸ìš”, {{ username }}ë‹˜!</p>
                <a href="{{ url_for('logout') }}" class="text-red-500 hover:underline">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        {% else %}
            <div class="text-center mb-4">
                <a href="{{ url_for('login_page') }}" class="text-blue-500 hover:underline">ë¡œê·¸ì¸</a> |
                <a href="{{ url_for('register_page') }}" class="text-blue-500 hover:underline">íšŒì›ê°€ì…</a>
            </div>
        {% endif %}
    </div>
</body>
</html>

<script>
  async function checkTokenStatus() {
      const cookies = document.cookie.split('; ').reduce((acc, cookie) => {
          const [name, value] = cookie.split('=');
          acc[name] = value;
          return acc;
      }, {});
  
      const now = Date.now();
  
      // âœ… Access Token ë§Œë£Œ ì„ë°• ì‹œ ìë™ ê°±ì‹ 
      if (cookies["access_token"]) {
          const tokenPayload = JSON.parse(atob(cookies["access_token"].split('.')[1]));
          const exp = tokenPayload.exp * 1000;
  
          if (exp - now < 5000) {  // ğŸ”¥ 5ì´ˆ ì´í•˜ë¡œ ë‚¨ìœ¼ë©´ ìë™ ê°±ì‹ 
              console.log("[DEBUG] Access Token ë§Œë£Œ ì„ë°•, Refresh Token ìš”ì²­");
              await fetch('/refresh-token', { method: 'POST', credentials: 'include' })
                  .then(response => response.json())
                  .then(data => {
                      if (data.access_token) {
                          console.log("[DEBUG] ìƒˆë¡œìš´ Access Token ë°œê¸‰ ì™„ë£Œ");
                          document.cookie = `access_token=${data.access_token}; path=/; HttpOnly`;
                      } else {
                          console.error("[ERROR] Access Token ê°±ì‹  ì‹¤íŒ¨");
                      }
                  })
                  .catch(error => console.error("[ERROR] Refresh Token ìš”ì²­ ì‹¤íŒ¨:", error));
          }
      }
  
      // âœ… Refresh Token ë§Œë£Œ ì‹œ ìë™ ë¡œê·¸ì•„ì›ƒ
      if (cookies["refresh_token"]) {
          const refreshPayload = JSON.parse(atob(cookies["refresh_token"].split('.')[1]));
          const refreshExp = refreshPayload.exp * 1000;
  
          if (refreshExp < now) {
              console.log("[DEBUG] Refresh Token ë§Œë£Œë¨, ìë™ ë¡œê·¸ì•„ì›ƒ ì‹¤í–‰");
              await fetch('/logout', { method: 'GET', credentials: 'include' })
                  .then(() => window.location.href = "/login");
          }
      }
  }
  
  // ğŸ”¥ 10ì´ˆë§ˆë‹¤ Access Token & Refresh Token ìƒíƒœ í™•ì¸
  setInterval(checkTokenStatus, 10000);
  </script>
  