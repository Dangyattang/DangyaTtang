<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>당신은 야식이 땡긴다</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.3/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="max-w-6xl mx-auto p-8 mt-16 bg-white shadow-lg rounded-lg">
        <h2 class="text-3xl font-bold text-center mb-6">당신은 야식이 땡긴다</h2>

        {% if username %}
            <div class="text-center mb-4">
                <p>안녕하세요, {{ username }}님!</p>
                <a href="{{ url_for('logout') }}" class="text-red-500 hover:underline">로그아웃</a>
            </div>
        {% else %}
            <div class="text-center mb-4">
                <a href="{{ url_for('login_page') }}" class="text-blue-500 hover:underline">로그인</a> |
                <a href="{{ url_for('register_page') }}" class="text-blue-500 hover:underline">회원가입</a>
            </div>
        {% endif %}
    </div>
</body>
</html>

<script>
  async function checkTokenStatus() {
      const cookies = document.cookie.split('; ').reduce((acc, cookie) => {
          const [name, value] = cookie.split('=');
          acc[name] = value;
          return acc;
      }, {});
  
      const now = Date.now();
  
      // ✅ Access Token 만료 임박 시 자동 갱신
      if (cookies["access_token"]) {
          const tokenPayload = JSON.parse(atob(cookies["access_token"].split('.')[1]));
          const exp = tokenPayload.exp * 1000;
  
          if (exp - now < 5000) {  // 🔥 5초 이하로 남으면 자동 갱신
              console.log("[DEBUG] Access Token 만료 임박, Refresh Token 요청");
              await fetch('/refresh-token', { method: 'POST', credentials: 'include' })
                  .then(response => response.json())
                  .then(data => {
                      if (data.access_token) {
                          console.log("[DEBUG] 새로운 Access Token 발급 완료");
                          document.cookie = `access_token=${data.access_token}; path=/; HttpOnly`;
                      } else {
                          console.error("[ERROR] Access Token 갱신 실패");
                      }
                  })
                  .catch(error => console.error("[ERROR] Refresh Token 요청 실패:", error));
          }
      }
  
      // ✅ Refresh Token 만료 시 자동 로그아웃
      if (cookies["refresh_token"]) {
          const refreshPayload = JSON.parse(atob(cookies["refresh_token"].split('.')[1]));
          const refreshExp = refreshPayload.exp * 1000;
  
          if (refreshExp < now) {
              console.log("[DEBUG] Refresh Token 만료됨, 자동 로그아웃 실행");
              await fetch('/logout', { method: 'GET', credentials: 'include' })
                  .then(() => window.location.href = "/login");
          }
      }
  }
  
  // 🔥 10초마다 Access Token & Refresh Token 상태 확인
  setInterval(checkTokenStatus, 10000);
  </script>
  