<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>당신은 야식이 땡긴다</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.3/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <!-- 폰트 헤더 -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Gasoek+One&display=swap"
      rel="stylesheet"
    />

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
      crossorigin="anonymous"
    ></script>
    <style>
      #orderregi {
        position: fixed;
        bottom: 60px;
        right: 60px;
      }
      .challange {
        margin: 10px auto 30px auto;
        width: 800px;
        text-align: center;

        border: 3px solid black;
        border-radius: 5px;

        padding: 5px;
      }
      .gasoek-one-regular {
        font-family: "Gasoek One", sans-serif;
        font-weight: 400;
        font-style: normal;
        position: relative;
        top: -5px;
      }

      .container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding: 10px;
      }

      .wrap {
        width: 800px;
        margin: 0 auto; /* 가로 중앙 정렬 */
      }

      .icon svg {
        width: 50px;
        height: 50px;
        margin: 10px;
      }
      .btngroup {
        display: flex;
        flex-wrap: nowrap; /* 버튼들이 한 줄에 맞지 않으면 자동으로 줄바꿈 */
        width: 800px; /* 너비를 800px로 설정 */
        margin: 0 auto; /* 가로 중앙 정렬 */
        justify-content: space-evenly; /* 버튼들 간에 균등한 간격을 설정 */
      }
      .btngroup button {
        width: 100px;
      }

      .max-w-7xl {
        max-width: 800px;
      }
    </style>
    <script>
      const API_BASE_URL = "http://127.0.0.1:5000"; // API 경로 (5000 포트)

      $(document).ready(function () {
        const modal = $("#crud-modal");
        const buttonContainer = $("#selected-buttons");
        const ordersContainer = $("#OrdersBox");

        // 페이지 로딩 시 팀 주문 전체 조회
        showOrders();

        // 모달 열기
        $("[data-modal-toggle='crud-modal']").on("click", function () {
          modal.toggleClass("hidden flex");
        });

        // 모달 닫기
        modal
          .find("button[data-modal-toggle='crud-modal']")
          .on("click", function () {
            modal.addClass("hidden").removeClass("flex");
          });

        // 팀 주문 등록
        $("#orderRegisterButton").on("click", function (e) {
          e.preventDefault();
          const kakaoUrl = $("#kakaoURL").val();
          const limitTime = $("#limitTime").val();
          const maxParticipants = $("#maxPerson").val();
          const selectedButtons = buttonContainer.find("button");
          const foodCategory = selectedButtons
            .map(function () {
              return $(this).attr("data-value");
            })
            .get();
          const detailMenu = $("#detailMenu").val();

          if (maxParticipants > 10) {
            alert("10명 이상은 추가할 수 없습니다 ❌");
            return;
          }

          $.ajax({
            type: "POST",
            url: `${API_BASE_URL}/order`,
            contentType: "application/json",
            data: JSON.stringify({
              kakaoUrl_give: kakaoUrl,
              limitTime_give: limitTime,
              maxPerson_give: maxParticipants,
              foodCategory_give: foodCategory,
              detailMenu_give: detailMenu,
            }),
            success: function (data) {
              alert(data.message);

              modal.addClass("hidden").removeClass("flex");
              showOrders();
            },
            error: function (error) {
              console.error("에러 발생:", error);
            },
          });
        });

        // 음식 카테고리 선택
        $("#food-category").on("change", function () {
          const selectedValue = $(this).val();

          // 최대 3개까지만 선택 가능
          if (buttonContainer.find("button[data-value]").length >= 3) {
            alert("최대 3개까지 선택할 수 있습니다.");
            $(this).val("");
            return;
          }

          // 이미 선택된 값인지 확인
          if (
            selectedValue &&
            buttonContainer.find(`[data-value="${selectedValue}"]`).length === 0
          ) {
            const button = $("<button>")
              .attr("data-value", selectedValue)
              .addClass(
                "flex items-center px-3 py-1 bg-blue-500 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition"
              )
              .text(selectedValue);

            const closeIcon = $(`
          <span class="cursor-pointer">
            <svg class="w-3 h-3 ml-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
          </span>
        `);

            closeIcon.on("click", function (event) {
              event.stopPropagation();
              button.remove();
            });

            button.append(closeIcon);
            buttonContainer.append(button);
          }

          $(this).val("");
        });

        // 카테고리별 조회 요청
        $(".getFoodCategoryButton").on("click", function () {
          const foodCategory = $(this).val();
          console.log(`선택된 카테고리: ${foodCategory}`);

          $.ajax({
            type: "GET",
            url: `${API_BASE_URL}/orders/category?category=${foodCategory}`,
            dataType: "json",
            success: function (data) {
              ordersContainer.empty();
              if (!data.length) {
                alert("조회된 목록이 없습니다");
                return;
              }
              for (let order of data) {
                makeOrder(
                  order._id,
                  order.food_category,
                  order.menu_details,
                  order.expires_at,
                  order.participants,
                  order.max_participants
                );
              }
            },
            error: function (error) {
              console.error(
                `"${foodCategory}" 카테고리 요청 중 오류 발생:`,
                error
              );
              alert("카테고리 선택 오류 발생");
            },
          });
        });

        // 주문 카드 생성 함수
        function makeOrder(
          orderid,
          menucatagory,
          menudetail,
          expires_at,
          participations,
          maxPerson
        ) {
          const currentTime = new Date();
          const expiresTime = new Date(expires_at); // ISO 8601 형식 변환
          const timeDiff = Math.floor((expiresTime - currentTime) / 60000); // 밀리초 -> 분 변환
          let timeDisplay =
            timeDiff > 0 ? `팀 주문 모집 마감 ${timeDiff}분 전` : "모집 종료";

          let tempHtml = `
            <div id="${orderid}" class="group bg-white dark:bg-[#1E2028] rounded-md overflow-hidden border border-gray-100 dark:border-gray-800 hover:border-indigo-500 dark:hover:border-indigo-500 transition-colors">
              <div class="p-4">
                <h3 class="text-lg font-medium text-black dark:text-white mt-2 group-hover:text-indigo-500 transition-colors line-clamp-2">${menucatagory}</h3>
                <div class="flex flex-wrap items-center gap-4 mt-4">
                  <span class="text-xs text-gray-500 dark:text-gray-400">${timeDisplay}</span>
                  <span class="text-xs text-gray-500 dark:text-gray-400"> 필요인원 : ${participations.length}/${maxPerson}</span>
                </div>
                <div class="mt-1">
                  <span class="text-xs text-gray-500 dark:text-gray-400">${menudetail}</span>
                </div>
                <div class="mt-2 flex justify-end">
                  <button class="px-4 py-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors">참가</button>
                </div>
              </div>
            </div>`;
          $("#OrdersBox").append(tempHtml);
        }

        function showOrders() {
          $.ajax({
            type: "GET",
            url: `${API_BASE_URL}/orders`,
            dataType: "json",
            success: function (data) {
              console.log(data, "전체 조회 성공");

              // 기존 카드 삭제 후 새로 추가
              ordersContainer.empty();

              for (let order of data) {
                makeOrder(
                  order._id,
                  order.food_category,
                  order.menu_details,
                  order.expires_at,
                  order.participants,
                  order.max_participants
                );
              }
            },
            error: function (error) {
              console.error("에러 발생:", error);
            },
          });
        }
      });
    </script>
  </head>
  <body>
    <div class="container">
      <div style="text-align: left">
        <span
          class="gasoek-one-regular"
          style="color: red; font-size: 40px; display: inline"
          >당</span
        >
        <span
          class="gasoek-one-regular"
          style="font-size: 40px; display: inline"
          >신은
        </span>
        <span
          class="gasoek-one-regular"
          style="color: red; font-size: 40px; display: inline"
          >야</span
        >
        <span
          class="gasoek-one-regular"
          style="font-size: 40px; display: inline"
          >식이
        </span>
        <span
          class="gasoek-one-regular"
          style="color: red; font-size: 40px; display: inline"
          >떙</span
        >
        <span
          class="gasoek-one-regular"
          style="font-size: 40px; display: inline"
          >긴다</span
        >
      </div>

      <!-- 오른쪽 정렬 -->
      <span
        id="user"
        style="font-family: Arial, Helvetica, sans-serif; font-size: x-large"
      >
        {% if username %}
        <div class="text-center mb-4">
          <a href="{{ url_for('personal') }}">안녕하세요, {{ username }}님!</a>
          <a href="{{ url_for('logout') }}" class="text-red-500 hover:underline"
            >로그아웃</a
          >
        </div>
        {% else %}
        <div class="text-center mb-4">
          <a
            href="{{ url_for('login_page') }}"
            class="text-blue-500 hover:underline"
            >로그인</a
          >
          |
          <a
            href="{{ url_for('register_page') }}"
            class="text-blue-500 hover:underline"
            >회원가입</a
          >
        </div>
        {% endif %}
      </span>
    </div>
    <div class="wrap">
      <!-- ✅ 이달의 야식왕 (독립된 섹션) -->
      <div class="text-center text-lg font-bold mb-6">
        {% if top_delivery_user %}
        <p class="text-2xl">
          🏆 이달의 야식왕
          <span class="text-red-500">'{{ top_delivery_user }}'</span>님! 🎉
        </p>
        {% else %}
        <p class="text-gray-600">
          아직 야식왕이 없습니다! 첫 번째 야식왕이 되어보세요!
        </p>
        {% endif %}
      </div>

      <!-- ✅ 음식 카테고리 필터 (별도 섹션) -->
      <div
        class="btngroup flex items-center justify-center rounded-md shadow-xs"
        role="group"
        style="width: 800px; margin: 0 auto"
      >
        <button
          type="button"
          value="치킨"
          class="getFoodCategoryButton px-4 py-2 text-sm font-medium text-gray-900 bg-transparent border border-gray-900 rounded-s-lg hover:bg-gray-900 hover:text-white"
        >
          치킨
        </button>
        <button
          type="button"
          value="피자"
          class="getFoodCategoryButton px-4 py-2 text-sm font-medium text-gray-900 bg-transparent border border-gray-900 hover:bg-gray-900 hover:text-white"
        >
          피자
        </button>
        <button
          type="button"
          value="중식"
          class="getFoodCategoryButton px-4 py-2 text-sm font-medium text-gray-900 bg-transparent border border-gray-900 hover:bg-gray-900 hover:text-white"
        >
          중식
        </button>
        <button
          type="button"
          value="일식"
          class="getFoodCategoryButton px-4 py-2 text-sm font-medium text-gray-900 bg-transparent border border-gray-900 hover:bg-gray-900 hover:text-white"
        >
          일식
        </button>
        <button
          type="button"
          value="양식"
          class="getFoodCategoryButton px-4 py-2 text-sm font-medium text-gray-900 bg-transparent border border-gray-900 hover:bg-gray-900 hover:text-white"
        >
          양식
        </button>
        <button
          type="button"
          value="분식"
          class="getFoodCategoryButton px-4 py-2 text-sm font-medium text-gray-900 bg-transparent border border-gray-900 hover:bg-gray-900 hover:text-white"
        >
          분식
        </button>
        <button
          type="button"
          value="탕,찌개"
          class="getFoodCategoryButton px-4 py-2 text-sm font-medium text-gray-900 bg-transparent border border-gray-900 hover:bg-gray-900 hover:text-white"
        >
          탕,찌개
        </button>
        <button
          type="button"
          value="고기"
          class="getFoodCategoryButton px-4 py-2 text-sm font-medium text-gray-900 bg-transparent border border-gray-900 hover:bg-gray-900 hover:text-white"
        >
          고기
        </button>
        <button
          type="button"
          value="디저트"
          class="getFoodCategoryButton px-4 py-2 text-sm font-medium text-gray-900 bg-transparent border border-gray-900 rounded-e-lg hover:bg-gray-900 hover:text-white"
        >
          디저트
        </button>
      </div>

      <br />
      <span class="gasoek-one-regular text-center text-3xl">팀 주문</span>
    </div>

    <!-- Minimal Blog Cards Grid -->
    <div class="max-w-7xl w-full mx-auto p-4" style="max-width: 800px">
      <!-- Cards Grid Container -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="OrdersBox">
        <!-- Card 1 -->
        <div
          id="orderid1"
          class="group bg-white dark:bg-[#1E2028] rounded-md overflow-hidden border border-gray-100 dark:border-gray-800 hover:border-indigo-500 dark:hover:border-indigo-500 transition-colors"
        >
          <div class="p-4">
            <!-- Title -->
            <h3
              class="text-lg font-medium text-black dark:text-white mt-2 group-hover:text-indigo-500 transition-colors line-clamp-2"
            >
              치킨 + 피자
            </h3>

            <!-- Meta Information -->
            <div class="flex flex-wrap items-center gap-4 mt-4">
              <span class="text-xs text-gray-500 dark:text-gray-400">
                남은시간 : 3분</span
              >
              <span class="text-xs text-gray-500 dark:text-gray-400">
                필요인원 : 2/5</span
              >
            </div>
            <div class="mt-1">
              <span class="text-xs text-gray-500 dark:text-gray-400"
                >#허니콤보 #하와이안피자</span
              >
            </div>
            <div class="mt-2 flex justify-end">
              <button
                class="px-4 py-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors"
              >
                참가
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div style="text-align: right" id="orderregi">
      <button
        data-modal-target="crud-modal"
        data-modal-toggle="crud-modal"
        class="px-6 py-2.5 border-2 border-red-500 text-red-500 rounded-lg hover:bg-red-50 transition-colors"
      >
        주문등록
      </button>
    </div>

    <!-- Main modal -->
    <div
      id="crud-modal"
      tabindex="-1"
      aria-hidden="true"
      class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full"
    >
      <div class="relative p-4 w-full max-w-2xl max-h-full">
        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
          <!-- Modal header -->
          <div
            class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200"
          >
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
              팀주문 열기
            </h3>
            <button
              type="button"
              class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"
              data-modal-toggle="crud-modal"
            >
              <svg
                class="w-3 h-3"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 14 14"
              >
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"
                />
              </svg>
              <span class="sr-only">Close modal</span>
            </button>
          </div>
          <!-- Modal body -->
          <form class="p-4 md:p-5">
            <div class="grid gap-4 mb-4 grid-cols-2">
              <div class="col-span-2">
                <label
                  for="kakaoURL"
                  class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                  >카카오톡 오픈채팅방 URL</label
                >
                <input
                  type="text"
                  id="kakaoURL"
                  class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                  placeholder="URL"
                  required=""
                />
              </div>
              <div class="col-span-2 sm:col-span-1">
                <label
                  for="category"
                  class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                  >제한시간</label
                >
                <select
                  id="limitTime"
                  class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                >
                  <option selected="">시간을 고르시오</option>
                  <option value="10">10</option>
                  <option value="20">20</option>
                  <option value="30">30</option>
                </select>
              </div>

              <div class="col-span-2 sm:col-span-1">
                <label
                  for="maxPerson"
                  class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                  >인원수</label
                >
                <input
                  type="number"
                  name="maxPerson"
                  id="maxPerson"
                  class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                  placeholder="0"
                  required=""
                  min="2"
                  max="10"
                />
              </div>

              <div class="col-span-2 sm:col-span-1">
                <label
                  for="foodcat"
                  class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                  >음식 카테고리</label
                >
                <select
                  id="food-category"
                  class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                >
                  <option selected="">음식 카테고리</option>
                  <option value="치킨">치킨</option>
                  <option value="피자">피자</option>
                  <option value="중식">중식</option>
                  <option value="일식">일식</option>
                  <option value="양식">양식</option>
                  <option value="분식">분식</option>
                  <option value="탕,찌개">탕,찌개</option>
                  <option value="고기">고기</option>
                  <option value="디저트">디저트</option>
                </select>
              </div>
              <div class="col-span-2 sm:col-span-1" id="selectedFood">
                <label
                  for="filterMenu"
                  class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                  >선택된 메뉴</label
                >
                <div
                  id="selected-buttons"
                  class="flex flex-wrap gap-2 mt-3"
                ></div>
              </div>
            </div>
            <div class="col-span-2 sm:col-span-1 mb-4">
              <label
                for="detailMenu"
                class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                >상세메뉴</label
              >
              <input
                type="text"
                id="detailMenu"
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                placeholder="내가 먹을 메뉴 입력"
                required=""
              />
            </div>
            <button
              type="button"
              id="orderRegisterButton"
              class="text-white inline-flex items-center bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
            >
              <svg
                class="me-1 -ms-1 w-5 h-5"
                fill="currentColor"
                viewBox="0 0 20 20"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                  clip-rule="evenodd"
                ></path>
              </svg>
              팀 주문 개설
            </button>
          </form>
        </div>
      </div>
    </div>
  </body>
</html>

<script>
  async function checkTokenStatus() {
    const cookies = document.cookie.split("; ").reduce((acc, cookie) => {
      const [name, value] = cookie.split("=");
      acc[name] = value;
      return acc;
    }, {});

    const now = Date.now();

    // ✅ Access Token 만료 임박 시 자동 갱신
    if (cookies["access_token"]) {
      const tokenPayload = JSON.parse(
        atob(cookies["access_token"].split(".")[1])
      );
      const exp = tokenPayload.exp * 1000;

      if (exp - now < 5000) {
        // 🔥 5초 이하로 남으면 자동 갱신
        console.log("[DEBUG] Access Token 만료 임박, Refresh Token 요청");
        await fetch("/refresh-token", {
          method: "POST",
          credentials: "include",
        })
          .then(response => response.json())
          .then(data => {
            if (data.access_token) {
              console.log("[DEBUG] 새로운 Access Token 발급 완료");
              document.cookie = `access_token=${data.access_token}; path=/; HttpOnly`;
            } else {
              console.error("[ERROR] Access Token 갱신 실패");
            }
          })
          .catch(error =>
            console.error("[ERROR] Refresh Token 요청 실패:", error)
          );
      }
    }

    // ✅ Refresh Token 만료 시 자동 로그아웃
    if (cookies["refresh_token"]) {
      const refreshPayload = JSON.parse(
        atob(cookies["refresh_token"].split(".")[1])
      );
      const refreshExp = refreshPayload.exp * 1000;

      if (refreshExp < now) {
        console.log("[DEBUG] Refresh Token 만료됨, 자동 로그아웃 실행");
        await fetch("/logout", { method: "GET", credentials: "include" }).then(
          () => (window.location.href = "/login")
        );
      }
    }
  }

  // 🔥 10초마다 Access Token & Refresh Token 상태 확인
  setInterval(checkTokenStatus, 10000);
</script>
